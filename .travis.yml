sudo: true

language: go

# Skip install step. Control by ourself
install: true

matrix:
  fast_finish: true
  include:
    - go: "1.10.x"
      os: linux
      dist: trusty
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-trusty
          packages:
            - g++-4.9
            - clang-8
            - clang-tools-8
            - clang-8-doc
            - libclang-common-8-dev
            - libclang-8-dev
            - libclang1-8
            - libllvm8
            - llvm-8
            - llvm-8-dev
            - llvm-8-runtime
            - libfuzzer-8-dev
            - lldb-8
            - lld-8
      env:
        - CGO_CXXFLAGS=-std=c++11
        - CGO_CPPFLAGS="`llvm-config-8 --cppflags`"
        - CGO_LDFLAGS="`llvm-config-8 --ldflags --libs --system-libs all`"
        - CGO_LDFLAGS_ALLOW='-Wl,(-search_paths_first|-headerpad_max_install_names)'
        - CC=clang-8
    - go: "1.10.x"
      os: linux
      dist: trusty
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-trusty-6.0
          packages:
            - g++-4.9
            - clang-6.0
            - clang-tools-6.0
            - clang-6.0-doc
            - libclang-common-6.0-dev
            - libclang-6.0-dev
            - libclang1-6.0
            - libllvm6.0
            - llvm-6.0
            - llvm-6.0-dev
            - llvm-6.0-runtime
            - libfuzzer-6.0-dev
            - lldb-6.0
            - lld-6.0
      env:
        - CGO_CXXFLAGS=-std=c++11
        - CGO_CPPFLAGS="`llvm-config-6.0 --cppflags`"
        - CGO_LDFLAGS="`llvm-config-6.0 --ldflags --libs --system-libs all`"
        - CGO_LDFLAGS_ALLOW='-Wl,(-search_paths_first|-headerpad_max_install_names)'
        - CC=clang-6.0
        - CXX=clang++-6.0
    - go: "1.10.x"
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-trusty-7
          packages:
            - g++-4.9
            - clang-7
            - clang-tools-7
            - clang-7-doc
            - libclang-common-7-dev
            - libclang-7-dev
            - libclang1-7
            - libllvm7
            - llvm-7
            - llvm-7-dev
            - llvm-7-runtime
            - libfuzzer-7-dev
            - lldb-7
            - lld-7
      env:
        - CGO_CXXFLAGS=-std=c++11
        - CGO_CPPFLAGS="`llvm-config-7 --cppflags`"
        - CGO_LDFLAGS="`llvm-config-7 --ldflags --libs --system-libs all`"
        - CGO_LDFLAGS_ALLOW='-Wl,(-search_paths_first|-headerpad_max_install_names)'
        - CC=clang-7
        - CXX=clang++-7

before_script:
  - go get -d llvm.org/llvm/bindings/go/llvm
  - go build $GOPATH/src/llvm.org/llvm/tools/llvm-go/llvm-go.go
  - ./llvm-go print-config > $GOPATH/src/llvm.org/llvm/bindings/go/llvm/llvm_config.go
  # use `-u` to avoid update llvm
  - go get -u -t -v ./...
script:
  - go test -coverprofile=coverage.txt -v ./...

