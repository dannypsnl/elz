sudo: true

language: go

go:
  - 1.10.x
  - 1.11.x
  - master

dist: trusty
addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
      - llvm-toolchain-trusty
    packages:
      - g++-4.9
      - clang-8
      - clang-tools-8
      - libclang-common-8-dev
      - libclang-8-dev
      - libclang1-8
      - libllvm8
      - llvm-8
      - llvm-8-dev
      - llvm-8-runtime
      - libfuzzer-8-dev
      - lldb-8
      - lld-8
env:
  - GO111MODULE=on CC=clang-8 CGO_CXXFLAGS=-std=c++11 CGO_LDFLAGS_ALLOW='Wl,(search_paths_first|headerpad_max_install_names)' CGO_CPPFLAGS="`llvm-config-8 --cppflags`" CGO_LDFLAGS="`llvm-config-8 --ldflags --libs --system-libs all`"

matrix:
  allow_failures:
    - go: 1.10.x # because it can't lock lib version
    - go: master
  fast_finish: true

before_script:
  - go generate ./...
  - go get -t -v ./...
script:
  - make test
  - make coverage
  - make build
after_success:
  - bash <(curl -s https://codecov.io/bash)
